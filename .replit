run = ["sh", "-c", "python -m flask --app start_webapp run --host 0.0.0.0 --port 5002"]
language = "python3"
entrypoint = "main.py"
modules = ["nodejs-20", "python-3.11"]

[env]
PYTHONPATH = "."
FLASK_APP = "start_webapp"

[nix]
channel = "stable-22_11"

# Fix the ports section to use an array format instead of object
[[ports]]
port = 5002
export = true
label = "WebApp"
description = "Web user interface"

[[ports]]
port = 5001
export = true
label = "API"
description = "API Server"

[debugger]
support = true

[multiplayer]
transport = "mp_transport"

[workflows]
runButton = "TestAndRun"

[[workflows.workflow]]
name = "WebApp"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python start_webapp.py"

[[workflows.workflow]]
name = "WebApp"
author = "agent"
mode = "sequential"

[workflows.workflow.metadata]
agentRequireRestartOnSave = false

[[workflows.workflow.tasks]]
task = "packager.installForAll"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "./run_diagnosis.sh"

[[workflows.workflow]]
name = "BasicAPI"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python basic_api.py"

[[workflows.workflow]]
name = "Run"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python start_webapp.py"

[[workflows.workflow]]
name = "Project"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "WebApp"

[[workflows.workflow]]
name = "DiagnosticServer"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 check_python.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 diagnose_env.py"

[[workflows.workflow]]
name = "WebAppFallback"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 diagnose_env.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 direct_diagnostic.py"

[[workflows.workflow]]
name = "TestPython"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "/mnt/nixmodules/nix/store/fj3r91wy2ggvriazbkl24vyarny6qb1s-python3-3.11.10-env/bin/python3 test_python.py"

[[workflows.workflow]]
name = "SystemVerification"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "/mnt/nixmodules/nix/store/fj3r91wy2ggvriazbkl24vyarny6qb1s-python3-3.11.10-env/bin/python3 run_tests.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "/mnt/nixmodules/nix/store/fj3r91wy2ggvriazbkl24vyarny6qb1s-python3-3.11.10-env/bin/python3 app_minimal.py"

[[workflows.workflow]]
name = "CoreWorkflow"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 -m unittest tests/test_core.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "python3 app_minimal.py"

[[workflows.workflow]]
name = "TestAndRun"
author = 37274620
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "/mnt/nixmodules/nix/store/fj3r91wy2ggvriazbkl24vyarny6qb1s-python3-3.11.10-env/bin/python3 -m pytest tests/test_basic.py tests/test_core.py tests/test_environment.py"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "/mnt/nixmodules/nix/store/fj3r91wy2ggvriazbkl24vyarny6qb1s-python3-3.11.10-env/bin/python3 app_minimal.py"

[deployment]
run = ["sh", "-c", "./run_diagnosis.sh"]
