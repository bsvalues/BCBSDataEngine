{% extends 'base.html' %}

{% block title %}BCBS Values - Dashboard{% endblock %}

{% block additional_head %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3">Property Valuation Dashboard</h1>
                <div class="btn-toolbar">
                    <div class="btn-group me-2">
                        <button id="refresh-btn" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="btn-group me-2">
                        <button id="auto-refresh-toggle" class="btn btn-outline-secondary">
                            <i class="bi bi-clock"></i> Auto Refresh: Off
                        </button>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                            <li><a class="dropdown-item" href="#" id="export-csv">Export to CSV</a></li>
                            <li><a class="dropdown-item" href="#" id="export-json">Export to JSON</a></li>
                            <li><a class="dropdown-item" href="#" id="export-excel">Export to Excel</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tabs -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties" type="button" role="tab" aria-controls="properties" aria-selected="true">
                <i class="bi bi-buildings"></i> Properties
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="etl-tab" data-bs-toggle="tab" data-bs-target="#etl" type="button" role="tab" aria-controls="etl" aria-selected="false">
                <i class="bi bi-database"></i> ETL Status
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="agents-tab" data-bs-toggle="tab" data-bs-target="#agents" type="button" role="tab" aria-controls="agents" aria-selected="false">
                <i class="bi bi-robot"></i> Agents
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab" aria-controls="analytics" aria-selected="false">
                <i class="bi bi-graph-up"></i> Analytics
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="dashboardTabContent">
        <!-- Properties Tab -->
        <div class="tab-pane fade show active" id="properties" role="tabpanel" aria-labelledby="properties-tab">
            <div class="row">
                <!-- Filters Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="card filter-sidebar">
                        <div class="card-body">
                            <h5><i class="bi bi-funnel"></i> Filters</h5>
                            
                            <div class="mb-3">
                                <label for="search" class="form-label">Search</label>
                                <div class="search-box">
                                    <input type="text" class="form-control" id="search" placeholder="Address, ID, etc.">
                                    <i class="bi bi-search search-icon"></i>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="neighborhood" class="form-label">Neighborhood</label>
                                <select class="form-select" id="neighborhood">
                                    <option value="">All Neighborhoods</option>
                                    <!-- Will be populated with API data -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="propertyType" class="form-label">Property Type</label>
                                <select class="form-select" id="propertyType">
                                    <option value="">All Types</option>
                                    <!-- Will be populated with API data -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Price Range</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control" id="minPrice" placeholder="Min">
                                    <span>-</span>
                                    <input type="number" class="form-control" id="maxPrice" placeholder="Max">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bedrooms</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="bedrooms" id="any-bed" value="" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="any-bed">Any</label>
                                    
                                    <input type="radio" class="btn-check" name="bedrooms" id="bed-1" value="1" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="bed-1">1+</label>
                                    
                                    <input type="radio" class="btn-check" name="bedrooms" id="bed-2" value="2" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="bed-2">2+</label>
                                    
                                    <input type="radio" class="btn-check" name="bedrooms" id="bed-3" value="3" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="bed-3">3+</label>
                                    
                                    <input type="radio" class="btn-check" name="bedrooms" id="bed-4" value="4" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="bed-4">4+</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Last Updated</label>
                                <select class="form-select" id="lastUpdated">
                                    <option value="">Any time</option>
                                    <option value="1">Last 24 hours</option>
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button id="apply-filters" class="btn btn-primary">Apply Filters</button>
                                <button id="reset-filters" class="btn btn-outline-secondary">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Properties List -->
                <div class="col-lg-9">
                    <!-- Summary Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="dashboard-card">
                                <div class="dashboard-card-body p-3 text-center">
                                    <div class="small text-secondary mb-1">Total Properties</div>
                                    <div class="h3 mb-0" id="total-properties">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="dashboard-card">
                                <div class="dashboard-card-body p-3 text-center">
                                    <div class="small text-secondary mb-1">Avg. Valuation</div>
                                    <div class="h3 mb-0" id="avg-valuation">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4 mb-md-0">
                            <div class="dashboard-card">
                                <div class="dashboard-card-body p-3 text-center">
                                    <div class="small text-secondary mb-1">Median Valuation</div>
                                    <div class="h3 mb-0" id="median-valuation">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card">
                                <div class="dashboard-card-body p-3 text-center">
                                    <div class="small text-secondary mb-1">Filtered Results</div>
                                    <div class="h3 mb-0" id="filtered-count">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property Data Visualization -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="dashboard-card-header">
                                    <h5 class="mb-0">Value Distribution</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="valueDistributionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            Chart Type
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="valueDistributionDropdown">
                                            <li><a class="dropdown-item chart-type" href="#" data-chart="bar">Bar Chart</a></li>
                                            <li><a class="dropdown-item chart-type" href="#" data-chart="pie">Pie Chart</a></li>
                                            <li><a class="dropdown-item chart-type" href="#" data-chart="histogram">Histogram</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="dashboard-card-body">
                                    <div class="chart-container">
                                        <canvas id="valueDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="dashboard-card-header">
                                    <h5 class="mb-0">Neighborhood Comparison</h5>
                                    <button class="btn btn-sm btn-outline-secondary" id="neighborhood-toggle">
                                        Show All
                                    </button>
                                </div>
                                <div class="dashboard-card-body">
                                    <div class="chart-container">
                                        <canvas id="neighborhoodComparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property Table -->
                    <div class="dashboard-card mb-4">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Property Valuations</h5>
                            <div class="d-flex align-items-center gap-2">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <span class="input-group-text">Show</span>
                                    <select class="form-select" id="page-size">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary d-md-none" id="filter-toggle">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="property_id">ID</th>
                                        <th class="sortable" data-sort="address">Address</th>
                                        <th class="sortable" data-sort="neighborhood">Neighborhood</th>
                                        <th class="sortable" data-sort="bedrooms">Beds</th>
                                        <th class="sortable" data-sort="square_feet">Sq Ft</th>
                                        <th class="sortable" data-sort="estimated_value">Valuation</th>
                                        <th class="sortable" data-sort="updated_at">Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="property-table-body">
                                    <!-- Will be populated with API data -->
                                    <tr class="property-loading-placeholder">
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mb-0">Loading property data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <div>
                                Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-count">0</span> properties
                            </div>
                            <nav aria-label="Property pagination">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" id="prev-page" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" id="next-page">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ETL Status Tab -->
        <div class="tab-pane fade" id="etl" role="tabpanel" aria-labelledby="etl-tab">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">ETL Pipelines</h5>
                        </div>
                        <div class="dashboard-card-body">
                            <div class="list-group list-group-flush" id="etl-pipeline-list">
                                <!-- Will be populated with API data -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mb-0">Loading ETL data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">ETL Job History</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Job Name</th>
                                        <th>Start Time</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Records</th>
                                    </tr>
                                </thead>
                                <tbody id="etl-job-table">
                                    <!-- Will be populated with API data -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Agents Tab -->
        <div class="tab-pane fade" id="agents" role="tabpanel" aria-labelledby="agents-tab">
            <div class="row">
                <div class="col-md-8 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Agent Status</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Status</th>
                                        <th>Last Heartbeat</th>
                                        <th>Current Task</th>
                                        <th>Queue</th>
                                        <th>Success Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agent-table">
                                    <!-- Will be populated with API data -->
                                    <tr class="agent-loading-placeholder">
                                        <td colspan="7" class="text-center py-5">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mb-0">Loading agent data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Agent Performance</h5>
                        </div>
                        <div class="dashboard-card-body">
                            <div class="chart-container">
                                <canvas id="agentPerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Valuation Trends</h5>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary active" data-period="30">30 Days</button>
                                <button type="button" class="btn btn-outline-secondary" data-period="90">90 Days</button>
                                <button type="button" class="btn btn-outline-secondary" data-period="365">Year</button>
                            </div>
                        </div>
                        <div class="dashboard-card-body">
                            <div class="chart-container">
                                <canvas id="valuationTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Model Distribution</h5>
                        </div>
                        <div class="dashboard-card-body">
                            <div class="chart-container">
                                <canvas id="modelDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <h5 class="mb-0">Feature Importance</h5>
                            <select class="form-select form-select-sm" style="width: auto;">
                                <option>All Models</option>
                                <option>Linear Regression</option>
                                <option>Ridge Regression</option>
                                <option>Gradient Boosting</option>
                                <option>Elastic Net</option>
                            </select>
                        </div>
                        <div class="dashboard-card-body">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="featureImportanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Property Detail Modal -->
    <div class="modal fade" id="propertyDetailModal" tabindex="-1" aria-labelledby="propertyDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="propertyDetailModalLabel">Property Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="property-detail-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading property details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" class="btn btn-primary" id="view-full-details">View Full Details</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent Detail Modal -->
    <div class="modal fade" id="agentDetailModal" tabindex="-1" aria-labelledby="agentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentDetailModalLabel">Agent Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="agent-detail-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading agent details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="restart-agent" disabled>Restart Agent</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard.js"></script>
{% endblock %}