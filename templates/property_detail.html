<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Valuation | BCBS_Values</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        .location-banner {
            background-color: var(--bs-info-bg-subtle);
            color: var(--bs-info-text);
            padding: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.25rem;
            text-align: center;
        }
        
        .property-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: var(--bs-body-bg);
        }
        
        .valuation-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: var(--bs-secondary-bg);
        }
        
        .feature-importance-bar {
            height: 20px;
            border-radius: 3px;
            margin-bottom: 5px;
            background-color: var(--bs-primary);
        }
        
        .property-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            background-color: var(--bs-secondary-bg);
        }
        
        .price-comparison {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.25rem;
        }
        
        .price-higher {
            background-color: var(--bs-success-bg-subtle);
            color: var(--bs-success-text);
        }
        
        .price-lower {
            background-color: var(--bs-danger-bg-subtle);
            color: var(--bs-danger-text);
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <header class="pb-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <span class="fs-4">BCBS_Values</span>
            </a>
        </header>
        
        <!-- Location Banner -->
        <div class="location-banner">
            <h5 class="mb-0">Location Focus: {{ location_focus }}</h5>
        </div>
        
        <!-- Navigation Links -->
        <div class="mb-4">
            <a href="/" class="btn btn-sm btn-outline-secondary me-2">Home</a>
            <a href="/properties" class="btn btn-sm btn-outline-secondary me-2">Properties</a>
            <a href="/search" class="btn btn-sm btn-outline-secondary me-2">Search</a>
            <a href="/validation" class="btn btn-sm btn-outline-secondary">Validation</a>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Property Details -->
        <div class="row">
            <div class="col-md-5">
                <div class="property-card">
                    <h1>Property Details</h1>
                    
                    <!-- Property Image Placeholder -->
                    <div class="property-img d-flex align-items-center justify-content-center">
                        <span class="text-muted">Property Image Placeholder</span>
                    </div>
                    
                    <div class="mb-4">
                        <h3>{{ property.address }}</h3>
                        <p class="mb-1">{{ property.city }}, {{ property.state }} {{ property.zip_code }}</p>
                        {% if property.property_type %}
                            <p class="mb-1">
                                <span class="badge bg-secondary">{{ property.property_type | title }}</span>
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <h5>Features</h5>
                            <ul class="list-unstyled">
                                <li><strong>Bedrooms:</strong> {{ property.bedrooms }}</li>
                                <li><strong>Bathrooms:</strong> {{ property.bathrooms }}</li>
                                <li><strong>Square Feet:</strong> {{ property.square_feet | int }}</li>
                                <li><strong>Year Built:</strong> {{ property.year_built }}</li>
                                <li><strong>Lot Size:</strong> {{ property.lot_size if property.lot_size else 'N/A' }}</li>
                            </ul>
                        </div>
                        <div class="col-6">
                            <h5>Price Info</h5>
                            <ul class="list-unstyled">
                                {% if property.list_price %}
                                    <li><strong>List Price:</strong> ${{ property.list_price | int }}</li>
                                {% endif %}
                                {% if property.last_sale_price %}
                                    <li><strong>Last Sale Price:</strong> ${{ property.last_sale_price | int }}</li>
                                {% endif %}
                                {% if property.last_sale_date %}
                                    <li><strong>Last Sale Date:</strong> {{ property.last_sale_date.strftime('%Y-%m-%d') if property.last_sale_date else 'N/A' }}</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5>Additional Information</h5>
                            <ul class="list-unstyled">
                                <li><strong>Property ID:</strong> {{ property.id }}</li>
                                {% if property.parcel_id %}
                                    <li><strong>Parcel ID:</strong> {{ property.parcel_id }}</li>
                                {% endif %}
                                <li><strong>Data Source:</strong> {{ property.data_source | upper }}</li>
                                <li><strong>Import Date:</strong> {{ property.import_date.strftime('%Y-%m-%d') if property.import_date else 'N/A' }}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <div class="valuation-card">
                    <h1>Property Valuation</h1>
                    
                    {% if valuation_results.error %}
                        <div class="alert alert-danger">
                            <h4>Valuation Error</h4>
                            <p>{{ valuation_results.error }}</p>
                        </div>
                    {% else %}
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-primary text-white mb-3">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Estimated Value</h5>
                                        <h2>${{ valuation_results.predicted_value | int }}</h2>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card bg-secondary mb-3">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Model Confidence</h5>
                                        <h4>R² Score: {{ "%.4f"|format(valuation_results.r2_score) }}</h4>
                                        <small class="text-muted">Higher is better (max 1.0)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if original_price and price_difference is not none %}
                            <div class="price-comparison {{ 'price-higher' if price_difference > 0 else 'price-lower' }}">
                                <h4 class="mb-2">Price Comparison</h4>
                                <p class="mb-1">Original {{ price_source | replace('_', ' ') | title }}: ${{ original_price | int }}</p>
                                <p class="mb-1">Estimated Value: ${{ valuation_results.predicted_value | int }}</p>
                                <p class="mb-0">
                                    <strong>Difference: ${{ price_difference | int }} ({{ "%.2f"|format(price_difference_percent) }}%)</strong>
                                    {% if price_difference > 0 %}
                                        <span class="ms-2">⬆️ Property may be undervalued</span>
                                    {% else %}
                                        <span class="ms-2">⬇️ Property may be overvalued</span>
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                        
                        <h4 class="mb-3">Feature Importance</h4>
                        <div class="feature-importance mb-4">
                            {% for feature in valuation_results.feature_importance %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{{ feature.feature | replace('_', ' ') | title }}</span>
                                        <span>{{ "%.4f"|format(feature.importance) }}</span>
                                    </div>
                                    <div class="feature-importance-bar" style="width: {{ (feature.importance / valuation_results.feature_importance[0].importance * 100) | int }}%"></div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <h4>Model Details</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Training Data</h5>
                                <ul>
                                    <li>Sample size: {{ valuation_results.data_metrics.sample_size }}</li>
                                    <li>Mean price: ${{ valuation_results.data_metrics.mean_price | int }}</li>
                                    <li>Median price: ${{ valuation_results.data_metrics.median_price | int }}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5>Price Range</h5>
                                <ul>
                                    <li>Min: ${{ valuation_results.data_metrics.price_range[0] | int }}</li>
                                    <li>Max: ${{ valuation_results.data_metrics.price_range[1] | int }}</li>
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="pt-3 mt-4 text-muted border-top">
            <p>&copy; 2025 BCBS_Values</p>
        </footer>
    </div>
</body>
</html>